name: Convert Documents

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install LibreOffice
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice libreoffice-impress imagemagick
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install Pillow
      
      - name: Create conversion script
        run: |
          cat > convert.py << 'EOF'
          import os
          import subprocess
          from pathlib import Path
          from PIL import Image

          def convert_docx_to_pdf(file_path):
              output_dir = Path("converted/pdfs") / file_path.parent.relative_to("Courses")
              output_dir.mkdir(parents=True, exist_ok=True)
              
              subprocess.run([
                  'libreoffice', '--headless', '--convert-to', 'pdf',
                  '--outdir', str(output_dir), str(file_path)
              ], timeout=120)
              print(f"âœ“ {file_path.name} â†’ PDF")

          def convert_pptx_to_images(file_path):
              pres_name = file_path.stem
              output_dir = Path("converted/presentations") / file_path.parent.relative_to("Courses") / pres_name
              output_dir.mkdir(parents=True, exist_ok=True)
              
              # PPTX â†’ PDF
              temp_pdf = output_dir / "temp.pdf"
              subprocess.run([
                  'libreoffice', '--headless', '--convert-to', 'pdf',
                  '--outdir', str(output_dir), str(file_path)
              ], timeout=120)
              
              generated_pdf = output_dir / f"{pres_name}.pdf"
              if generated_pdf.exists():
                  generated_pdf.rename(temp_pdf)
              
              # PDF â†’ Images
              subprocess.run([
                  'convert', '-density', '300', '-quality', '95',
                  str(temp_pdf), str(output_dir / 'slide-%03d.jpg')
              ], timeout=300)
              
              # Optimize
              for img in output_dir.glob('slide-*.jpg'):
                  image = Image.open(img)
                  if image.width > 1920:
                      ratio = 1920 / image.width
                      new_height = int(image.height * ratio)
                      image = image.resize((1920, new_height), Image.Resampling.LANCZOS)
                  image.save(img, 'JPEG', quality=90, optimize=True)
              
              temp_pdf.unlink()
              print(f"âœ“ {file_path.name} â†’ {len(list(output_dir.glob('slide-*.jpg')))} slides")

          # Find and convert files
          for docx in Path("Courses").rglob("*.docx"):
              convert_docx_to_pdf(docx)
          
          for pptx in Path("Courses").rglob("*.pptx"):
              convert_pptx_to_images(pptx)
          EOF
      
      - name: Run conversion
        run: python convert.py
      
      - name: Commit converted files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add converted/
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”„ Auto-converted documents"
          git push
