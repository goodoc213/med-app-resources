name: Convert Courses to PDF

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice-writer libreoffice-calc libreoffice-impress libreoffice-core poppler-utils
      
      - name: Install Python packages
        run: |
          pip install reportlab Pillow python-docx openpyxl pypdf markdown beautifulsoup4 lxml
      
      - name: Create converter script
        run: |
          cat > convert_files.py << 'ENDOFFILE'
          import os
          import subprocess
          from pathlib import Path
          from reportlab.lib.pagesizes import letter, A4
          from reportlab.pdfgen import canvas
          from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
          from reportlab.lib.styles import getSampleStyleSheet
          from reportlab.lib import colors
          from PIL import Image
          import zipfile
          
          class GitHubPDFConverter:
              def __init__(self):
                  self.output_dir = Path("PDF_Courses")
                  self.output_dir.mkdir(exist_ok=True)
                  self.converted_files = []
              
              def find_files_to_convert(self):
                  """Find all non-PDF files in the repository"""
                  files = []
                  extensions = ['.docx', '.doc', '.xlsx', '.xls', '.csv', '.pptx', '.ppt', 
                               '.txt', '.md', '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.html']
                  
                  for ext in extensions:
                      files.extend(Path('.').rglob(f'*{ext}'))
                  
                  # Filter out files already in PDF_Courses and .git folder
                  files = [f for f in files if 'PDF_Courses' not in str(f) and '.git' not in str(f)]
                  return files
              
              def convert_file(self, input_path):
                  """Convert a file to PDF"""
                  input_path = Path(input_path)
                  ext = input_path.suffix.lower()
                  
                  # Create same folder structure in output
                  relative_path = input_path.relative_to('.')
                  output_subdir = self.output_dir / relative_path.parent
                  output_subdir.mkdir(parents=True, exist_ok=True)
                  output_path = output_subdir / f"{input_path.stem}.pdf"
                  
                  # Skip if already converted and up-to-date
                  if output_path.exists():
                      if output_path.stat().st_mtime >= input_path.stat().st_mtime:
                          return None
                  
                  print(f"Converting: {input_path}")
                  
                  try:
                      if ext in ['.docx', '.doc', '.xlsx', '.xls', '.pptx', '.ppt', '.csv']:
                          return self.convert_office(input_path, output_path)
                      elif ext in ['.txt', '.md']:
                          return self.convert_text(input_path, output_path)
                      elif ext in ['.jpg', '.jpeg', '.png', '.gif', '.bmp']:
                          return self.convert_image(input_path, output_path)
                      elif ext == '.html':
                          return self.convert_text(input_path, output_path)
                  except Exception as e:
                      print(f"Error converting {input_path}: {e}")
                      return None
              
              def convert_office(self, input_path, output_path):
                  """Convert Office files using LibreOffice"""
                  try:
                      result = subprocess.run([
                          'libreoffice', '--headless', '--convert-to', 'pdf',
                          '--outdir', str(output_path.parent), str(input_path)
                      ], capture_output=True, timeout=120, text=True)
                      
                      if result.returncode == 0:
                          print(f"âœ“ {output_path.name}")
                          return output_path
                      else:
                          print(f"âœ— Failed: {result.stderr}")
                          return None
                  except Exception as e:
                      print(f"âœ— Error: {e}")
                      return None
              
              def convert_text(self, input_path, output_path):
                  """Convert text files to PDF"""
                  with open(input_path, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()
                  
                  doc = SimpleDocTemplate(str(output_path), pagesize=letter)
                  styles = getSampleStyleSheet()
                  story = []
                  
                  title = Paragraph(f"<b>{input_path.name}</b>", styles['Title'])
                  story.append(title)
                  story.append(Spacer(1, 20))
                  
                  for line in content.split('\n'):
                      if line.strip():
                          line = line.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;')
                          para = Paragraph(line, styles['Normal'])
                          story.append(para)
                      else:
                          story.append(Spacer(1, 6))
                  
                  doc.build(story)
                  print(f"âœ“ {output_path.name}")
                  return output_path
              
              def convert_image(self, input_path, output_path):
                  """Convert images to PDF"""
                  img = Image.open(input_path)
                  
                  if img.mode in ('RGBA', 'LA', 'P'):
                      background = Image.new('RGB', img.size, (255, 255, 255))
                      if img.mode == 'P':
                          img = img.convert('RGBA')
                      if img.mode in ('RGBA', 'LA'):
                          background.paste(img, mask=img.split()[-1])
                      else:
                          background.paste(img)
                      img = background
                  elif img.mode != 'RGB':
                      img = img.convert('RGB')
                  
                  c = canvas.Canvas(str(output_path), pagesize=letter)
                  width, height = letter
                  
                  img_width, img_height = img.size
                  scale = min((width - 100) / img_width, (height - 100) / img_height, 1)
                  
                  c.drawInlineImage(img, 50, 50, 
                                   width=img_width * scale, 
                                   height=img_height * scale)
                  c.save()
                  print(f"âœ“ {output_path.name}")
                  return output_path
              
              def run(self):
                  """Run the conversion process"""
                  files = self.find_files_to_convert()
                  
                  if not files:
                      print("No files to convert")
                      return
                  
                  print(f"Found {len(files)} files to process")
                  
                  for file in files:
                      result = self.convert_file(file)
                      if result:
                          self.converted_files.append(result)
                  
                  print(f"\nConverted {len(self.converted_files)} files")
                  
                  # Create index file
                  self.create_index()
              
              def create_index(self):
                  """Create an index of all PDF files"""
                  index_path = self.output_dir / "INDEX.md"
                  
                  with open(index_path, 'w') as f:
                      f.write("# Dental School Courses - PDF Index\n\n")
                      f.write(f"Total Files: {len(list(self.output_dir.rglob('*.pdf')))}\n\n")
                      
                      # Group by folder
                      folders = {}
                      for pdf in sorted(self.output_dir.rglob('*.pdf')):
                          folder = pdf.parent.relative_to(self.output_dir)
                          if folder not in folders:
                              folders[folder] = []
                          folders[folder].append(pdf)
                      
                      for folder in sorted(folders.keys()):
                          if str(folder) == '.':
                              f.write("## Root Files\n\n")
                          else:
                              f.write(f"## {folder}\n\n")
                          
                          for pdf in sorted(folders[folder]):
                              rel_path = pdf.relative_to(self.output_dir)
                              f.write(f"- [{pdf.name}]({rel_path})\n")
                          f.write("\n")
          
          if __name__ == "__main__":
              converter = GitHubPDFConverter()
              converter.run()
          ENDOFFILE
      
      - name: Run conversion
        run: python convert_files.py
      
      - name: Check if there are changes
        id: verify_diff
        run: |
          git diff --quiet PDF_Courses/ || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push PDFs
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PDF_Courses/
          git commit -m "ðŸ”„ Auto-converted courses to PDF"
          git push
